---
title: 'ã€Laravelã€‘userã®emailãŒuniqueã§ãªã„å ´åˆã¯Passwordãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ã«ã‚ˆã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã¯ã§ããªã„ãƒƒ!!'
emoji: 'ğŸ”' # https://www.webfx.com/tools/emoji-cheat-sheet/
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['laravel', 'php', 'email', 'password', 'auth']
published: true
---

## ã¯ã˜ã‚ã«
ã“ã‚“ã«ã¡ã¯ã€‚
å…ˆæ—¥ã€emailã®uniqueã‚’å¤–ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€Passwordãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ã®`Password::sendResetLink()`ã‚„`Password::reset()`ã‚’ä½¿ã£ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã¨ã“ã‚ã€å¤§ãƒã‚°ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰å´ã®ã‚³ãƒ¼ãƒ‰ã‚‚ã¡ã‚ƒã‚“ã¨èª­ã¿ãªã•ã„ã¨ã„ã†è‡ªåˆ†ã¸ã®æˆ’ã‚ã‚’è¾¼ã‚ã¦è¨˜äº‹ã‚’æ›¸ã¾ã™â€¦ã€‚

[//]: # (### ãŸã¨ãˆã°)


[//]: # (## è§£èª¬ã™ã‚‹ã“ã¨ãƒ»ã—ãªã„ã“ã¨)

### ç’°å¢ƒ
Laravel 10.42


## ãªãœPasswordãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã§ããªã„ã®ã‹
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã«ä½¿ç”¨ã•ã‚Œã‚‹password_reset_tokensãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
mysql> SHOW COLUMNS FROM password_reset_tokens;
+------------+--------------+------+-----+---------+-------+
| Field      | Type         | Null | Key | Default | Extra |
+------------+--------------+------+-----+---------+-------+
| email      | varchar(255) | NO   | PRI | NULL    |       |
| token      | varchar(255) | NO   |     | NULL    |       |
| created_at | timestamp    | YES  |     | NULL    |       |
+------------+--------------+------+-----+---------+-------+
```

emailã‚’primaryã¨ã—ã¦ãŠã‚Šã€emailã®é‡è¤‡ã«è€ãˆã‚‹ä½œã‚Šã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚

ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼Cã®emailãŒé‡è¤‡ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚’è¡Œã£ãŸå ´åˆã©ã†ãªã‚‹ã®ã§ã—ã‚‡ã†ã€‚
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼A**ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ â†’ **ãƒ¦ãƒ¼ã‚¶ãƒ¼A**ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚Œã‚‹
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼B**ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ â†’ **ãƒ¦ãƒ¼ã‚¶ãƒ¼A**ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚Œã‚‹
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼C**ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ â†’ **ãƒ¦ãƒ¼ã‚¶ãƒ¼A**ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚Œã‚‹

idãŒè‹¥ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¸¸ã«æ›´æ–°ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

ï¼ˆå†…éƒ¨çš„ãªå‡¦ç†ã¯ã“ã“ã§ã¯è§£èª¬ã—ã¾ã›ã‚“ã®ã§ã€æ°—ã«ãªã£ãŸæ–¹ã¯ `vendor/laravel/framework/src/Illuminate/Auth/Passwords/PasswordBroker.php` ã®`sendResetLink()`ã‚„`reset()`ã‚’è¿½ã£ã¦ã¿ã¦ãã ã•ã„ï¼‰


## Passwordãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ã‚’ä½¿ãˆãªã„ãªã‚‰ã©ã†ã™ã‚Œã°è‰¯ã„ã®ï¼Ÿ

:::message alert
ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã©ç«¯æŠ˜ã£ã¦ç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™ã€‚
:::

1. ã¾ãšã¯ãƒˆãƒ¼ã‚¯ãƒ³ç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚Šç›´ã—ã¾ã™ã€‚

```PHP:database/migrations/2014_10_12_100000_create_password_reset_tokens_table.php
public function up(): void
{
    Schema::create('password_reset_tokens', function (Blueprint $table) {
        $table->id();
        $table->foreignIdFor(User::class)->unique();
        $table->string('token');
        $table->timestamp('created_at')->nullable();
    });
}
```

```
mysql> SHOW COLUMNS FROM password_reset_tokens;
+------------+-----------------+------+-----+---------+----------------+
| Field      | Type            | Null | Key | Default | Extra          |
+------------+-----------------+------+-----+---------+----------------+
| id         | bigint unsigned | NO   | PRI | NULL    | auto_increment |
| user_id    | bigint unsigned | NO   | UNI | NULL    |                |
| token      | varchar(255)    | NO   |     | NULL    |                |
| created_at | timestamp       | YES  |     | NULL    |                |
+------------+-----------------+------+-----+---------+----------------+
```

2. ç¶šã„ã¦ãƒ¢ãƒ‡ãƒ«ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è²¼ã‚Šã¾ã™ã€‚
```PHP:app/Models/User.php
public function password_reset_token(): HasOne
{
    return $this->hasOne(PasswordResetToken::class);
}
```

```PHP:app/Models/PasswordResetToken.php
public function user(): BelongsTo
{
    return $this->belongsTo(User::class);
}
```

3. ãã‚Œã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®å‡¦ç†ã‚’è‡ªä½œã—ã¾ã™ã€‚

```PHP
/**
 * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡å‡¦ç†
 *
 * @param ResetPasswordEmailRequest $request
 * @return RedirectResponse
 */
public function email(ResetPasswordEmailRequest $request): RedirectResponse
{
    $loginId = $request->getLoginId();
    $token = generateToken();

    $user = User::whereLoginId($loginId)->firstOrFail();
    PasswordResetToken::updateOrCreate(['user_id' => $user->id], [
        'token' => $token,
        'created_at' => Carbon::now(),
    ]);

    $user->notify(new ResetPasswordNotification($token, $user->id));

    return to_route('password.request')->with(['success_message' => __('passwords.sent')]);
}
```

```PHP
/**
 * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†
 *
 * @param ResetPasswordUpdateRequest $request
 * @return RedirectResponse
 */
public function update(ResetPasswordUpdateRequest $request): RedirectResponse
{
    $userId = $request->getUserId();
    $token = $request->getToken();
    $password = $request->getPassword();

    $user = User::findOrFail($userId);
    $passwordResetToken = $user->password_reset_token;

    if ($passwordResetToken === null || $passwordResetToken->token !== $token) {
        return back()->withErrors(['error_message' => __('passwords.token')]);
    }

    $createdAt = $passwordResetToken->created_at;
    if ($createdAt->addMinutes(config('auth.passwords.users.expire'))->isPast()) {
        return back()->withErrors(['error_message' => __('passwords.expired')]);
    }

    User::whereId($user->id)->update([
        'password' => Hash::make($password),
    ]);

    PasswordResetToken::destroy($passwordResetToken->id);

    return to_route('login')->with(['success_message' => __('passwords.reset')]);
}
```

ä»¥ä¸Šã§ã™ã€‚


## ãŠã¾ã‘
æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã¯ `php artisan auth:clear-resets` ã‚’å®Ÿè¡Œã™ã‚Œã°å‰Šé™¤ã§ãã¾ã™ã€‚


## å‚è€ƒ
https://readouble.com/laravel/10.x/ja/passwords.html
